---
# Ansible Playbook to Configure Jenkins Agent Worker Node
# This playbook automates the setup of the Jenkins agent with all dependencies
# Usage: ansible-playbook playbooks/jenkins_agent.yml -i inventory/hosts.yml

- name: Configure Jenkins Agent Worker Node
  hosts: jenkins_agent
  become: yes # Run with sudo
  vars:
    jenkins_user: jenkins
    jenkins_home: /home/jenkins
    jenkins_workspace: /home/jenkins/jenkins
    docker_group: docker

  tasks:
    # System Update
    - name: Update apt package cache
      apt:
        update_cache: yes
      tags: system

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
      tags: system

    # Java Installation
    - name: Install OpenJDK 17
      apt:
        name: openjdk-17-jdk
        state: present
      tags: java

    - name: Verify Java installation
      shell: java -version
      register: java_version
      tags: java

    - name: Display Java version
      debug:
        msg: 'Java installed: {{ java_version.stderr_lines[0] }}'
      tags: java

    # Docker Installation
    - name: Install Docker prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
      tags: docker

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags: docker

    - name: Add Docker repository
      apt_repository:
        repo: 'deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable'
        state: present
      tags: docker

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
      tags: docker

    - name: Install Docker Compose
      shell: |
        curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
      args:
        creates: /usr/local/bin/docker-compose
      tags: docker

    - name: Enable Docker service
      systemd:
        name: docker
        enabled: yes
        state: started
      tags: docker

    - name: Verify Docker installation
      shell: docker --version
      register: docker_version
      tags: docker

    - name: Display Docker version
      debug:
        msg: 'Docker installed: {{ docker_version.stdout }}'
      tags: docker

    # Git Installation
    - name: Install Git
      apt:
        name: git
        state: present
      tags: git

    - name: Verify Git installation
      shell: git --version
      register: git_version
      tags: git

    - name: Display Git version
      debug:
        msg: 'Git installed: {{ git_version.stdout }}'
      tags: git

    # Python Installation
    - name: Add deadsnakes PPA for Python 3.11
      apt_repository:
        repo: 'ppa:deadsnakes/ppa'
        state: present
      tags: python

    - name: Install Python 3.11 and pip
      apt:
        name:
          - python3.11
          - python3.11-venv
          - python3.11-dev
          - python3-pip
        state: present
        update_cache: yes
      tags: python

    - name: Verify Python 3.11 installation
      shell: python3.11 --version
      register: python_version
      tags: python

    - name: Display Python version
      debug:
        msg: 'Python 3.11 installed: {{ python_version.stdout }}'
      tags: python

    - name: Upgrade pip and install pip tools
      shell: python3.11 -m pip install --upgrade pip setuptools wheel
      tags: python

    - name: Configure pip cache directory for jenkins user
      file:
        path: '{{ jenkins_home }}/.cache/pip'
        state: directory
        owner: '{{ jenkins_user }}'
        group: '{{ jenkins_user }}'
        mode: '0755'
      tags: python

    - name: Create .pip directory for jenkins user
      file:
        path: '{{ jenkins_home }}/.pip'
        state: directory
        owner: '{{ jenkins_user }}'
        group: '{{ jenkins_user }}'
        mode: '0755'
      tags: python

    - name: Create pip configuration file
      copy:
        dest: '{{ jenkins_home }}/.pip/pip.conf'
        content: |
          [global]
          cache-dir = {{ jenkins_home }}/.cache/pip
          index-url = https://pypi.org/simple/
        mode: '0644'
        owner: '{{ jenkins_user }}'
        group: '{{ jenkins_user }}'
      tags: python

    # Node.js Installation
    - name: Add NodeSource GPG key
      apt_key:
        url: https://keyserver.ubuntu.com/pks/lookup?op=get&fingerprint=on&search=0x1655A0AB68576280
        state: present
      tags: nodejs

    - name: Add NodeSource repository
      apt_repository:
        repo: 'deb https://deb.nodesource.com/node_20.x {{ ansible_distribution_release }} main'
        state: present
      tags: nodejs

    - name: Remove conflicting npm package
      apt:
        name: npm
        state: absent
      tags: nodejs

    - name: Install Node.js (npm will be installed as dependency)
      apt:
        name: nodejs
        state: present
        update_cache: yes
      tags: nodejs

    - name: Verify Node.js installation
      shell: node --version
      register: node_version
      tags: nodejs

    - name: Display Node.js version
      debug:
        msg: 'Node.js installed: {{ node_version.stdout }}'
      tags: nodejs

    - name: Verify npm installation
      shell: npm --version
      register: npm_version
      tags: nodejs

    - name: Display npm version
      debug:
        msg: 'npm installed: {{ npm_version.stdout }}'
      tags: nodejs

    # Additional utilities and build tools
    - name: Install build tools and development libraries
      apt:
        name:
          - build-essential
          - gcc
          - g++
          - make
          - libpq-dev
          - postgresql-client
          - python3.11-venv
          - python3.11-dev
          - wget
          - curl
          - vim
          - net-tools
          - htop
          - openssh-server
        state: present
      tags: utilities

    # Jenkins User Setup
    - name: Create jenkins user
      user:
        name: '{{ jenkins_user }}'
        shell: /bin/bash
        home: '{{ jenkins_home }}'
        createhome: yes
        state: present
      tags: jenkins_user

    - name: Add jenkins user to docker group
      user:
        name: '{{ jenkins_user }}'
        groups: '{{ docker_group }}'
        append: yes
      tags: jenkins_user

    - name: Allow jenkins user to use docker without sudo
      lineinfile:
        path: /etc/sudoers
        line: '{{ jenkins_user }} ALL=(ALL) NOPASSWD:ALL'
        state: present
      tags: jenkins_user

    # SSH Setup
    - name: Create .ssh directory for jenkins user
      file:
        path: '{{ jenkins_home }}/.ssh'
        state: directory
        owner: '{{ jenkins_user }}'
        group: '{{ jenkins_user }}'
        mode: '0700'
      tags: ssh

    - name: Add public key to authorized_keys
      authorized_key:
        user: '{{ jenkins_user }}'
        state: present
        key: "{{ lookup('file', '/tmp/ssh-keys/id_ed25519.pub') }}"
      tags: ssh

    - name: Set authorized_keys permissions
      file:
        path: '{{ jenkins_home }}/.ssh/authorized_keys'
        owner: '{{ jenkins_user }}'
        group: '{{ jenkins_user }}'
        mode: '0600'
      tags: ssh

    # Jenkins Workspace
    - name: Create jenkins workspace directory
      file:
        path: '{{ jenkins_workspace }}'
        state: directory
        owner: '{{ jenkins_user }}'
        group: '{{ jenkins_user }}'
        mode: '0755'
      tags: jenkins_workspace

    - name: Create jenkins workspace subdirectories
      file:
        path: '{{ jenkins_workspace }}/{{ item }}'
        state: directory
        owner: '{{ jenkins_user }}'
        group: '{{ jenkins_user }}'
        mode: '0755'
      loop:
        - workspace
        - logs
        - tools
      tags: jenkins_workspace

    # SSH Configuration
    - name: Ensure SSH service is enabled
      systemd:
        name: ssh
        enabled: yes
        state: started
      tags: ssh

    - name: Configure SSH for key-based authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '{{ item.regexp }}'
        line: '{{ item.line }}'
        state: present
      loop:
        - {
            regexp: '^#?PubkeyAuthentication',
            line: 'PubkeyAuthentication yes',
          }
        - {
            regexp: '^#?PasswordAuthentication',
            line: 'PasswordAuthentication no',
          }
        - {
            regexp: '^#?PermitRootLogin',
            line: 'PermitRootLogin prohibit-password',
          }
      notify: restart ssh
      tags: ssh

    # Security hardening
    - name: Set up firewall (UFW)
      ufw:
        rule: allow
        port: '{{ item }}'
        proto: tcp
      loop:
        - '22' # SSH
        - '50000' # Jenkins JNLP
      tags: firewall

    - name: Enable UFW
      ufw:
        state: enabled
      tags: firewall

    # Docker pull test images
    - name: Pull Docker test images
      shell: |
        docker pull python:3.11-slim &
        docker pull node:20-alpine &
        docker pull hello-world &
        wait
      become_user: '{{ jenkins_user }}'
      tags: docker_images
      async: 300
      poll: 10

    # Verification
    - name: Verify all installations
      block:
        - name: Check Java
          shell: java -version 2>&1 | head -1
          register: java_check

        - name: Check Python
          shell: python3 --version
          register: python_check

        - name: Check pip
          shell: python3 -m pip --version
          register: pip_check

        - name: Check Docker
          shell: docker --version
          register: docker_check

        - name: Check Docker Compose
          shell: docker-compose --version
          register: compose_check

        - name: Check Git
          shell: git --version
          register: git_check

        - name: Check Node.js
          shell: node --version
          register: node_check

        - name: Check npm
          shell: npm --version
          register: npm_check

        - name: Check Jenkins user
          shell: id {{ jenkins_user }}
          register: jenkins_user_check

        - name: Display verification results
          debug:
            msg: |
              Java: {{ java_check.stdout_lines[0] if java_check.stdout_lines else 'Not found' }}
              Python: {{ python_check.stdout }}
              pip: {{ pip_check.stdout }}
              Node.js: {{ node_check.stdout }}
              npm: {{ npm_check.stdout }}
              Docker: {{ docker_check.stdout }}
              Docker Compose: {{ compose_check.stdout }}
              Git: {{ git_check.stdout }}
              Jenkins User: {{ jenkins_user_check.stdout }}

      tags: verification

    # Final status
    - name: Agent configuration complete
      debug:
        msg: |
          ========================================
          Jenkins Agent Configuration Complete!
          ========================================

          Agent Details:
          - Jenkins User: {{ jenkins_user }}
          - Jenkins Home: {{ jenkins_home }}
          - Workspace: {{ jenkins_workspace }}
          - SSH Key: Configured ({{ jenkins_user }}@agent)

          Installed Software:
          - Java: OpenJDK 17
          - Python: Python 3.11 with pip
          - Node.js: Node.js 20
          - npm: Latest
          - Docker: Latest
          - Docker Compose: Latest
          - Git: Latest

          Firewall:
          - Port 22 (SSH): Open
          - Port 50000 (JNLP): Open
          ========================================
      tags: always

  handlers:
    - name: restart ssh
      systemd:
        name: ssh
        state: restarted
